name: Build and Release

permissions:
    contents: write

on:
    push:
        branches: ["main"]
        tags: ["v*"]
    pull_request:
        branches: ["main"]

env:
    BINARY_NAME: edbgserver

jobs:
    build:
        name: Build ${{ matrix.target }}
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                include:
                    - target: x86_64-unknown-linux-musl
                      arch: x86_64
                    - target: aarch64-unknown-linux-musl
                      arch: aarch64

        steps:
            # 1. Checkout source code
            - name: Checkout repository
              uses: actions/checkout@v4

            # 2. Install Rust Stable (Project requirement 1)
            # We also add the target architecture here
            - name: Install Rust Stable
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            # 3. Install Rust Nightly with rust-src (Project requirement 2)
            # This is required for compiling the eBPF component
            - name: Install Rust Nightly
              uses: dtolnay/rust-toolchain@nightly
              with:
                  components: rust-src

            # 4. Install LLVM (Project requirement 5)
            # Required for bpf-linker and compiling eBPF
            - name: Install LLVM
              run: sudo apt-get update && sudo apt-get install -y llvm clang

            # 5. Cache Cargo dependencies
            # This significantly speeds up the workflow by caching bpf-linker and cargo-zigbuild
            - name: Cache Cargo tools
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                  key: ${{ runner.os }}-cargo-tools-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-cargo-tools-

            # 6. Install bpf-linker (Project requirement 7)
            - name: Install bpf-linker
              run: |
                  if ! command -v bpf-linker &> /dev/null; then
                    cargo install bpf-linker
                  fi

            # 7. Install cargo-zigbuild (Project requirement 3 & Build command)
            # This tool simplifies cross-compilation using Zig
            - name: Install cargo-zigbuild
              run: |
                  if ! command -v cargo-zigbuild &> /dev/null; then
                    cargo install cargo-zigbuild
                  fi

            # 8. Install Zig (Implicit requirement for cargo-zigbuild)
            # cargo-zigbuild needs the actual zig binary.
            # We use python's pip to install a managed version, or let cargo-zigbuild handle it.
            # Here we explicitly install ziglang via pip for reliability.
            - name: Install Zig
              uses: goto-bus-stop/setup-zig@v2
              with:
                  version: 0.13.0 # Or specific version required by project

            # 9. Build the project
            # Uses the command specified in "Build & Run" section
            - name: Build Binary
              run: cargo zigbuild --release --target ${{ matrix.target }}

            # 10. Prepare artifact
            # Renames the binary to include the architecture (e.g., edbgserver-x86_64)
            - name: Rename and Move Binary
              run: |
                  mkdir -p dist
                  cp target/${{ matrix.target }}/release/${{ env.BINARY_NAME }} dist/${{ env.BINARY_NAME }}-${{ matrix.arch }}

            # 11. Upload Artifact to GitHub Actions Summary
            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.BINARY_NAME }}-${{ matrix.arch }}
                  path: dist/${{ env.BINARY_NAME }}-${{ matrix.arch }}

    release:
        name: Create Release
        needs: build
        if: startsWith(github.ref, 'refs/tags/v')
        runs-on: ubuntu-latest
        steps:
            - name: Download Artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts
                  merge-multiple: true

            - name: List Artifacts
              run: ls -R artifacts

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: artifacts/*
                  generate_release_notes: true
